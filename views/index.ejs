<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <title>SpaceLab</title>
        <link rel=stylesheet href=/app/assets/css/magic.css>
        <link rel=stylesheet href=/app/assets/css/iview.css>
        <link rel=stylesheet href=/app/css/index.css>
    </head>
    <body>
    <div class=panel-body style="display: none">
        <div id=sales-chart style="height: 250px;"></div>
    </div>
    <div id=app>
        <div class="content">
            <div class="content-left">
                <template>
                    用户：<i-input v-model="username" placeholder="用户名" style="width: 200px" />
                </template>
                <template>
                    密码：<i-input v-model="ps" type="password" placeholder="密码" style="width: 200px" />
                </template>
                <template>
                    演唱会id：<i-input v-model="detailId" placeholder="输入演唱会URL地址" style="width: 200px" />
                </template>
                <template>
                    时间（选择月份即可）：<Date-Picker type="date" v-model="date" placeholder="Select date" style="width: 200px"></Date-Picker>
                </template>
                <div style="height: 5px"></div>
                <br />
                <template>
                    姓名：<i-input v-model="user" placeholder="姓名" style="width: 200px" />
                </template>
                <template>
                    电话：<i-input v-model="tel_1" placeholder="010" style="width: 60px" />
                </template>
                <template>
                    -<i-input v-model="tel_2" type="password" placeholder="5811" style="width: 60px" />
                </template>
                <template>
                    -<i-input v-model="tel_3" type="password" placeholder="2859" style="width: 65px" />
                </template>
                <template>
                    邮寄地址：<i-input v-model="address" placeholder="输入地址" style="width: 500px" />
                </template>
                <div style="height: 5px"></div>
                <br />
                <template>
                    邮箱：<i-input v-model="email" placeholder="输入邮箱" style="width: 130px" />
                </template>
                <br />
                <template>
                    <i-button type="primary" style="margin-top: 10px" @click="running">开始抢票</i-button>
                </template>
            </div>
            <!-- 内容 -->
            <div class="frame-content">
                <h3 style="padding: 0px 10px;color: #a01717dd;">当前演唱会【本月】场次时间：</h3>
                <p class="playtime">{{monthList.join(' , ')}}</p>

                <h3 style="padding: 0px 10px;color: #a01717dd;">演唱会抢票状态：</h3>
                <p class="result">[{{sDateStatus}}]</p>

                <h3 style="padding: 0px 10px;color: #a01717dd;">获取当前日期{{date}}场次信息：</h3>
                <p class="result">{{step3}}.......</p>

                <h3 style="padding: 0px 10px;color: #a01717dd;">获取当天{{date}}场次时间：</h3>
                <div class="result">当天场次：
                    <ul>
                        <li v-for="item in playTime">
                            {{ item.label }}
                        </li>
                    </ul>
               </div>

                <h3 style="padding: 0px 10px;color: #a01717dd;">获取时间：【{{date}}】, 场次:【{{playTime.length? playTime[0].label : ''}}】的坐席信息：</h3>
                <div class="result">坐席：
                    <ul>
                        <li v-for="item in seatInfo">
                            <span>{{ item.quyu }},</span><span>{{item.count}}</span>
                        </li>
                    </ul>
                </div>

                <h3 style="padding: 0px 10px;color: #a01717dd;">获取时间：【{{date}}】, 演唱会信息：</h3>
                <div class="result" v-html="playInfo">弹框选座，选座价格</div>

                <h3 style="padding: 0px 10px;color: #a01717dd;">获取时间：【{{date}}】, 演唱会信息：</h3>
                <div class="result" v-html="seatPrice">弹框选座，选座价格</div>

                <span class="fenge">............................................................</span>
                <h3 style="padding: 0px 10px;color: #a01717dd;">进入选座环节：【{{date}}】....</h3>
                <div class="result">智能选座</div>
               <!-- <h3 style="padding: 0px 10px;color: #a01717dd;">获取当天{{date}}场次时间：</h3>
                <p class="result">当天场次：{{playTime.join(' , ')}}</p>-->
            </div>
        </div>
    </div>
    <script src=/app/assets/js/jquery-1.10.2.min.js></script>
    <script src=/app/assets/js/vue.min.js></script>
    <script src=/app/assets/js/iview.min.js></script>
    <script>
        $(function() {

          new Vue({
            el: '#app',
            data: {
              iframeUrl:'/*http://ticket.yes24.com/Pages/Perf/Detail/Detail.aspx?IdPerf=30851&Gcode=009_112_001*/',
              visible: false,
              email:'',
              address:'',
              date:'',
              detailId:'30851',///*http://ticket.yes24.com/Pages/Perf/Detail/Detail.aspx?IdPerf=30851&Gcode=009_112_001*/
              user:'',
              tel_1:'',
              tel_2:'',
              tel_3:'',
              username:'',
              ps:'',
              /**
               * 本月可选场次
               */
              monthList: [],
              dateStatus: false,
              sDateStatus:'待开始',
              resDate :'',
              step3: '',

              // 当天的场次信息
              playTime:[],
              // 场次里面的坐席信息
              seatInfo: [],
              // 获取某一天的演唱会详情（场次等等）
              playInfo:'',
              // 获取某一天的某一场次，或者某一集的价格和座位
              seatPrice:''
            },
            methods: {
              running: function() {
                let that = this;

                if (!this.date || !this.detailId) {
                  alert('请填写演唱会id和日期。');
                  return;
                }
                let date  = new Date(this.date);
                let sDate = `${date.getFullYear()}-${date.getMonth() + 1}`;

                $.ajax({
                  url    : `/index/fetchdetail?id=${that.detailId}&date=${sDate}`,
                  success: function(res) {
                    //console.log(res);
                    //$('.frame-content').html(res);
                    that.monthList = res;

                    /**
                     * 获取对应的坐席1
                     */
                    let current = +date;

                    res.forEach(v=>{
                      if(current === +new Date(`${v}  00:00:00`))
                      {
                        that.resDate = v;
                        that.dateStatus = true;
                        that.sDateStatus = '可以抢票';
                      }
                    })

                    if(that.dateStatus){
                        that.step3 = '开始获取坐席';
                        that.fetchPlayTime();
                    }
                  },
                });
              },

              /**
               * 获取演唱会的具体时间。下面3点，7点等
               * 返回值：<option value='' selected='selected'>회차 선택</option><option value='976608'>오후 3시 00분</option><option value='976612'>오후 7시 00분</option>
               * 或者 <option value='976600'>오후 8시 00분</option>
               *
               */
              fetchPlayTime: function() {
                let that = this;
                $.ajax({
                  url    : `/index/fetchplaytime?id=${that.detailId}&date=${that.resDate.replace(/-/g, '')}`,
                  success: function(res) {
                    let list = $(res);
                    let aTime = [];
                    let i = 0;

                    if(list.length > 1) i=1;

                    for(i; list[i]; i++){
                      aTime.push({label:list[i].text, value: list[i].getAttribute('value')});
                    }

                    that.playTime = aTime;

                    /**
                     * todo 这个地方需要提供一个选择按钮
                     * todo 默认选择第一个
                     */
                    that.fetchRemainseat();

                  },
                });
              },
              /**
               *  获取坐席
               */
              fetchRemainseat: function() {
                let that = this;
                let id   = that.playTime.length? that.playTime[0].value : '';

                $.ajax({
                  url    : `/index/remainseat?id=${id}`,
                  success: function(res) {
                    //that.playTime = res;
                    console.log(res);
                    let list = $(res);
                    let aTime = [];
                    let i = 0;

                    if(list.length > 1) i=1;

                    for(i; list[i]; i++){
                      let item = list.eq(i);

                      let quyu = item.find('span').eq(0).text()//R区
                      let count = item.find('span').eq(1).text()// 座位数

                      aTime.push({quyu:quyu, count: count});
                    }

                    that.seatInfo = aTime;

                    /**
                     * 接下来是选座环节
                     * 这里面有一句代码很有意思，js,里面的，是在打开iframe的时候
                     *  $j(document).ready(function () {

                        if (window.opener == null) {
                            alert("예매버튼을 이용하여 예매 부탁 드립니다."); //“请利用预售按钮预购一下。”强制要求用预售按钮打开
                            location.href = "/pages/Main.aspx";
                        }
                     */
                    that.fetchPlayInfo();
                  },
                });
              },
              /**
               * 根据时间和演唱会id获取具体的场次在iframe页面打开
               *
               */
              fetchPlayInfo: function() {
                let that = this;

                $.ajax({
                  url    : `/index/fetchplayinfo?id=${that.detailId}&date=${that.resDate.replace(/-/g, '')}`,
                  success: function(res) {
                    console.log(res);
                    that.playInfo = res;

                    /**
                     * 获取当前的一集的价格和座位
                     */
                    that.fetchSeatprice();

                  }
                })
              },

              /**
               * 价格和座位
               */
              fetchSeatprice: function() {
                let that = this;
                let id   = that.playTime.length? that.playTime[0].value : '';
                $.ajax({
                  url    : `/index/fetchseatprice?id=${id}`,
                  success: function(res) {
                    console.log(res);
                    that.seatPrice = res;
                  }
                })
              },

              show: function () {
                this.visible = true;
              }
            }
          })


          var opened = true;
          $('.top-btn').click(function() {

            if(opened)
              $('.left-content').animate({
                'width':'0px'
              }, 'speed', function() {
                opened = false;
              });
            else
              $('.left-content').animate({
                'width':'187px'
              }, 'speed', function() {
                opened = true;
              });

          });

        })
    </script>
    </body>
</html>